<?phpnamespace App\Http\Controllers\Poker;use App\Http\Controllers\Controller;use App\Models\Poker\ClubObs;use App\Models\Poker\Club;use App\Models\Poker\ClubUser;use App\Models\Poker\License;use App\Models\Poker\ClubIndicado;use Illuminate\Http\Request;use Illuminate\Support\Facades\Auth;use Illuminate\Support\Facades\DB;use Illuminate\Support\Facades\Session;use Illuminate\Support\Facades\View;class CrmController extends Controller{    /**     * Display a listing of the resource.     *     * @param  \Illuminate\Http\Request  $request     * @return \Illuminate\Http\Response     */    public function index(Request $request)    {        $countreg = 100;        if ($request['count']) {            if (is_numeric($request['count'])) {                $countreg = intval($request['count']);            }        }        $lista = ClubObs::        select('*')            ->orderby('id','desc')            ->limit($countreg)            ->get();        $lista_oount = count($lista);        for ( $iw = 0; $iw < $lista_oount; $iw++  ) {            $adm = DB::table('users')->where('id', '=', $lista[$iw]['user_id'])->first();            if ($adm) {                $lista[$iw]['adm'] = $adm->name;            } else {                $lista[$iw]['adm'] = 'ANONOMO';            }            if (($lista[$iw]['status']!=='0')&&($lista[$iw]['status']!=='3')) {                $adm = DB::table('users')->where('id', '=', $lista[$iw]['obs_user_id'])->first();                if ($adm) {                    $lista[$iw]['adm2'] = $adm->name;                } else {                    $lista[$iw]['adm2'] = 'ANONOMO';                }            }            $club = Club::where('id', '=', $lista[$iw]['club_id'])->first();            $lista[$iw]['club'] = $club['name'];        }        return view('poker.crms.list',compact('lista'));    }    /**     * Display a listing of the resource.     *     * @param  \Illuminate\Http\Request  $request     * @return \Illuminate\Http\Response     */    public function save(Request $request)    {        $not_id = $request['not_id'];        if ($not_id === '0') {            $cad = new ClubObs();            $club_id = $request['club_id'];            $obs_status = $request['obs_status'];            $obs_text = $request['obs_text'];            $notify_admin = $request['notify_admin'];            $notify_at = $request['notify_at'];            $cad->obs_id = 0;            $cad->club_id = $club_id;            $cad->status = $obs_status;            $cad->obs_return = "";            $cad->obs = $obs_text;            if ($notify_admin === 'true') {                $cad->notify_admin = 1;                $cad->notify_at = $notify_at;            } else {                $cad->notify_admin = 0;            }            if (Auth::check()) {                $cad->user_id = Auth::user()->id;            } else {                $cad->user_id = 0;            }            $msg_notify = 'Nota cadastrada com sucesso!!!';        } else {            $cad = ClubObs::find($not_id);            $obs_status = $request['obs_status'];            $obs_text = $request['obs_text'];            $cad->status = $obs_status;            $cad->obs_return = $obs_text;            if (Auth::check()) {                $cad->obs_user_id = Auth::user()->id;            } else {                $cad->obs_user_id = 0;            }            $msg_notify = 'Status alterado com sucesso!!!';        }        $cad->save();        return [            'result' => 'S'            , 'message' => $msg_notify        ];    }    public function CrmsClub($club_id){        //licenÃ§as        $lista = ClubObs::whereclub_id($club_id)->orderby('id')->get();        $lista_oount = count($lista);        for ( $iw = 0; $iw < $lista_oount; $iw++  ) {            $adm = DB::table('users')->where('id', '=', $lista[$iw]['user_id'])->first();            if ($adm)                $lista[$iw]['adm'] = $adm->name;            else $lista[$iw]['adm'] = 'ANONOMO';            if (($lista[$iw]['status']!=='0')&&($lista[$iw]['status']!=='3')) {                $adm = DB::table('users')->where('id', '=', $lista[$iw]['obs_user_id'])->first();                if ($adm) {                    $lista[$iw]['adm2'] = $adm->name;                } else {                    $lista[$iw]['adm2'] = 'ANONOMO';                }            }            $club = Club::where('id', '=', $lista[$iw]['club_id'])->first();            $lista[$iw]['club'] = $club['name'];        }        //montar o html        $html = View::make('poker.crms.ofclub', compact('lista'))->render();        //retorno        return [            'result' => 'S'            , 'html' => $html        ];    }}